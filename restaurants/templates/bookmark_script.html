<script>
let filterActive = false;

function toggleBookmark(event) {
    event.preventDefault();
    event.stopPropagation();

    const btn = event.currentTarget;
    const restaurantId = btn.dataset.id;

    fetch("{% url 'restaurants:toggle_bookmark' %}", {
        method: "POST",
        headers: {
            "X-CSRFToken": "{{ csrf_token }}",
            "Content-Type": "application/x-www-form-urlencoded"
        },
        body: new URLSearchParams({ restaurant_id: restaurantId })
    })
    .then(res => {
        if (!res.ok) {
            throw new Error(`Server responded with status: ${res.status}`);
        }
        return res.json();
    })
    .then(data => {
        const icon = btn.querySelector("i");
        const card = btn.closest('.restaurant-card');

        if (data.bookmarked) {
            icon.classList.remove("bi-bookmark");
            icon.classList.add("bi-bookmark-fill", "text-yellow-400");
            card.dataset.bookmarked = "true";
        } else {
            icon.classList.remove("bi-bookmark-fill", "text-yellow-400");
            icon.classList.add("bi-bookmark", "text-gray-300");
            card.dataset.bookmarked = "false";
        }
    })
    .catch(error => {
        console.error('Failed to toggle bookmark:', error);
        alert('Could not update bookmark. Please try again later.');
    });
}

document.querySelectorAll(".bookmark-btn").forEach(btn => {
    btn.addEventListener("click", toggleBookmark);
});

const bookmarkFilterBtn = document.getElementById("bookmarkFilterBtn");

bookmarkFilterBtn.addEventListener("click", () => {
    filterActive = !filterActive;

    bookmarkFilterBtn.querySelector("i").classList.toggle("text-yellow-400", filterActive);

    const cards = document.querySelectorAll(".restaurant-card");

    cards.forEach(card => {
        const isBookmarked = card.dataset.bookmarked === "true";
        const link = card.closest("a"); // find the <a> wrapping the card

        if (filterActive && !isBookmarked) {
            link.classList.add("hidden"); // hide full grid item
        } else {
            link.classList.remove("hidden"); // show full grid item
        }
    });
});

function toggleVisited(event) {
  event.preventDefault();

  const btn = event.currentTarget;
  const restaurantId = btn.dataset.id;

  fetch("{% url 'restaurants:toggle_visited' %}", {
    method: "POST",
    headers: {
      "X-CSRFToken": "{{ csrf_token }}",
      "Content-Type": "application/x-www-form-urlencoded"
    },
    body: new URLSearchParams({ restaurant_id: restaurantId })
  })
  .then(res => res.json())
  .then(data => {
    if (data.visited) {
      btn.textContent = "Unvisit";
      btn.classList.remove("bg-red-500");
      btn.classList.add("bg-red-700");
      btn.closest(".restaurant-card").dataset.visited = "true";
    } else {
      btn.textContent = "Visit";
      btn.classList.remove("bg-red-700");
      btn.classList.add("bg-red-500");
      btn.closest(".restaurant-card").dataset.visited = "false";
    }
  });
}

let visitedFilterActive = false;

const visitedFilterBtn = document.getElementById("visitedFilterBtn");

visitedFilterBtn.addEventListener("click", () => {
  visitedFilterActive = !visitedFilterActive;

  visitedFilterBtn.querySelector("i")
    .classList.toggle("text-yellow-400", visitedFilterActive);

    document.querySelectorAll(".restaurant-card").forEach(card => {
        const link = card.closest("a");
        const isVisited = card.dataset.visited === "true";

        if (visitedFilterActive && !isVisited) {
            link.classList.add("hidden");
        } else {
            link.classList.remove("hidden");
        }
    });
});

</script>
